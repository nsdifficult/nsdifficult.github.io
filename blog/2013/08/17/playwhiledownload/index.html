
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>音视频边播放边下载技术调研及问题 - My Octopress Blog</title>
	<meta name="author" content="Your Name">

	
	<meta name="description" content="介绍 需求 实现在音视频播放的时候即进行缓冲，即边播放边下载。 技术介绍 思路来自http://www.cnblogs.com/zhouguixin/p/3139522.html。要点是在先开一个下载的线程下载视频文件，然后在本地建一个server，然后拼接一个url给播放器。 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="http://libs.useso.com/js/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">My Octopress Blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:nsdifficult.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:nsdifficult.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">音视频边播放边下载技术调研及问题</h2>
	<div class="entry-content"><h1 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-介绍">介绍</h1>


<!--more-->


<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-需求">需求</h2>


<p>实现在音视频播放的时候即进行缓冲，即边播放边下载。</p>

<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-技术介绍">技术介绍</h2>


<p>思路来自<a href="http://www.cnblogs.com/zhouguixin/p/3139522.html" rel="nofollow"><a href="http://www.cnblogs.com/zhouguixin/p/3139522.html">http://www.cnblogs.com/zhouguixin/p/3139522.html</a></a>。要点是在先开一个下载的线程下载视频文件，然后在本地建一个server，然后拼接一个url给播放器。</p>

<h1 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-代码实现中遇到的问题">代码实现中遇到的问题</h1>


<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-现象">现象</h2>


<p>点击播放，MPMovicePlayerController报错，错误为：</p>

<div>
<div><strong>错误日志</strong></div>
<div>
<div>
<div id="highlighter_886016">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>2013</code><code>-</code><code>06</code><code>-</code><code>27</code> <code>18</code><code>:</code><code>49</code><code>:</code><code>28.727</code> <code>TibetVoice[</code><code>7748</code><code>:c07] {</code></div>
<div><code>    </code><code>MPMoviePlayerPlaybackDidFinishReasonUserInfoKey = </code><code>1</code><code>;</code></div>
<div><code>    </code><code>error = </code><code>"Error Domain=MediaPlayerErrorDomain Code=-11828 \"Cannot Open\" UserInfo=0x9246dc0 {NSLocalizedDescription=Cannot Open}"</code><code>;</code></div>
<div><code>}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-分析1">分析1</h2>


<p>使用的断点续传的开源库是<a href="https://github.com/steipete/AFDownloadRequestOperation" rel="nofollow">AFDownloadRequestOperation</a>，它将缓冲文件保存的文件名没有后缀，后来想到缓冲文件需要和原始文件一致，更改缓冲文件命名方式为：</p>

<div>
<div><strong>更改命名规则</strong></div>
<div>
<div>
<div id="highlighter_139116">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>NSString *md5URLString = [[self.targetPath lastPathComponent] stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];</code></div>
<div><code>        </code><code>//NSString *md5URLString = [NSString stringWithFormat:@"%@",[[self class] md5StringForString:self.targetPath]];</code></div>
<div><code>        </code><code>tempPath = [[[self </code><code>class</code><code>] cacheFolder] stringByAppendingPathComponent:md5URLString]; </code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<p>更改后发现视频还是不能报错，错误为：</p>

<div>
<div><strong>错误日志</strong></div>
<div>
<div>
<div id="highlighter_134531">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>2013</code><code>-</code><code>06</code><code>-</code><code>27</code> <code>18</code><code>:</code><code>57</code><code>:</code><code>08.870</code> <code>TibetVoice[</code><code>7808</code><code>:c07] {</code></div>
<div><code>    </code><code>MPMoviePlayerPlaybackDidFinishReasonUserInfoKey = </code><code>1</code><code>;</code></div>
<div><code>    </code><code>error = </code><code>"Error Domain=MediaPlayerErrorDomain Code=-11800 \"The operation could not be completed\" UserInfo=0x914be70 {NSLocalizedDescription=The operation could not be completed}"</code><code>;</code></div>
<div><code>}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-分析2">分析2</h2>


<p>边播放边下载的实现方式来源于<a href="http://www.cnblogs.com/zhouguixin/p/3139522.html" rel="nofollow"><a href="http://www.cnblogs.com/zhouguixin/p/3139522.html">http://www.cnblogs.com/zhouguixin/p/3139522.html</a></a>，文章中有一段：</p>

<div>
<div><strong>解释</strong></div>
<div>
<div>
<div id="highlighter_34034">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>是有一点需要自己实现：当httpserver接受到MPMoviePlayerController的请求时，server要先返回一个请求包含了整个</code></div>
<div><code>视频文件的大小。然后MPMoviePlayerController才会不断请求本地的服务器取数据。我的实现是这样的。当要比方某个视频文件的时候，</code></div>
<div><code>先开启一个request去下载，当收到文件总大小的时候，存到本地的一个dictionary中，request继续下载，然后打开</code></div>
<div><code>localserver，拼一个本地url给player，让他自动播放。当localserver收到请求时，根据要请求的文件去本地读文件的实际大</code></div>
<div><code>小，返回给player，然后player就可以播放了。</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<p>这段开始看的不明就里，后来在google上搜到<a href="https://groups.google.com/forum/#%21topic/cocoahttpserver/-da-UI44w0Y" rel="nofollow">这篇文章</a>，里面有一段话：</p>

<div>
<div><strong>解释</strong></div>
<div>
<div>
<div id="highlighter_885035">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>Hello Robbiehanson!</code></div>
<div></div>
<div><code>Thanks </code><code>for</code> <code>your works!</code></div>
<div></div>
<div><code>I'm implement your project to play video streaming. In method "-</code></div>
<div></div>
<div><code>(NSObject&lt;HTTPResponse&gt; *)httpResponseForMethod:(NSString *)method URI:</code></div>
<div></div>
<div><code>(NSString *)path" i'm using HTTPAsyncFileResponse and set fileLength</code></div>
<div></div>
<div><code>of file on server. But video is playing with no sound. So what was the</code></div>
<div></div>
<div><code>reason?</code></div>
<div></div>
<div><code>Thanks!.</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<p>明白了要把<a href="https://github.com/robbiehanson/CocoaHTTPServer" rel="nofollow">cocoahttpserver</a>中的设置读取文件大小的代码，让本地服务器以视频原始文件大小去读：</p>

<div>
<div><strong>修改读取文件的大小</strong></div>
<div>
<div>
<div id="highlighter_39416">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>//fileLength = (UInt64)[[fileAttributes objectForKey:NSFileSize] unsignedLongLongValue];</code></div>
<div><code>  </code><code>fileLength = [FileTools fileSizeWithUrl:filePath];</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<p>再运行，发现能播放了</p>

<h1 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-播放mp4流和hls流问题">播放mp4流和hls流问题</h1>


<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-mp4">mp4</h2>


<p>播放mp4正常</p>

<h2 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-m3u8">m3u8</h2>


<p>点击播放，MPMovicePlayerController报错，错误为：</p>

<div>
<div><strong>错误日志</strong></div>
<div>
<div>
<div id="highlighter_46561">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>2013</code><code>-</code><code>06</code><code>-</code><code>27</code> <code>19</code><code>:</code><code>15</code><code>:</code><code>18.372</code> <code>TibetVoice[</code><code>7885</code><code>:c07] Error: Error Domain=NSCocoaErrorDomain Code=</code><code>516</code> <code>"The operation couldn’t be completed.</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<h3 id="id-(2013-06-27)音视频边播放边下载技术调研及问题-分析">分析</h3>


<p>到虚拟机的应用目录下看到本地有一个m3u8文件，打开发现是：</p>

<div>
<div><strong>m3u8</strong></div>
<div>
<div>
<div id="highlighter_810498">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td>
<div title="Hint: double-click to select code">
<div><code>#EXTM3U</code></div>
<div><code>#EXT-X-TARGETDURATION:</code><code>10</code></div>
<div><code>#EXT-X-MEDIA-SEQUENCE:</code><code>0</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence0.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence1.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence2.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence3.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence4.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence5.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence6.ts</code></div>
<div><code>#EXTINF:</code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence7.ts</code></div>
<div><code>#EXTINF:<code></code></code><code>10</code><code>, no desc</code></div>
<div><code>fileSequence8.ts</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


<p>即m3u8只是指向很多ts文件的一个文件列表，当然不能播放。如果需要想要实现对HTTP LIVE STREAMING (hls)的边播放边下载，还需要解析这个索引文件，然后再分别下载，再组装成一个视频文件然后播放，当然，这就不是边播放边下载了。</p>

<p>例子见：<a href="https://github.com/nsdifficult/DownloadWhilePlaying">DownloadWhilePlaying</a></p>
</div>


<div class="meta">
	<div class="date">




Aug 17th, 2013</div>
	<div class="tags">

</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Your Name

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>