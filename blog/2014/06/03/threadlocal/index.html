
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>ThreadLocal - å›¾æ ·å›¾æ£®ç ´å•ŠğŸ˜„</title>
	<meta name="author" content="æ˜“è£ä¹‰">

	
	<meta name="description" content="è§£é‡Š Thread-local storage æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å­˜å‚¨çš„å­˜å‚¨ã€‚
ç»´åŸºç™¾ç§‘è§£é‡Š Thread-local storage (TLS) is a computer programming method that uses static or global memory &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="å›¾æ ·å›¾æ£®ç ´å•ŠğŸ˜„" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="http://libs.useso.com/js/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">å›¾æ ·å›¾æ£®ç ´å•ŠğŸ˜„</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">ä¸»é¡µ</a></li>
	<li><a href="/blog/archives">æ‰€æœ‰æ–‡ç« </a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">ä¸»é¡µ</a></li>
	<li><a href="/blog/archives">æ‰€æœ‰æ–‡ç« </a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:rongyi.work">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:rongyi.work">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">ThreadLocal</h2>
	<div class="entry-content"><h2>è§£é‡Š</h2>

<p>Thread-local storage æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å­˜å‚¨çš„å­˜å‚¨ã€‚<br/>
<a href="https://en.wikipedia.org/wiki/Thread-local_storage#Java">ç»´åŸºç™¾ç§‘è§£é‡Š</a></p>

<blockquote><p>Thread-local storage (TLS) is a computer programming method that uses static or global memory local to a thread.<!--more--></p></blockquote>

<p>Thread-local storageæœ‰å„ä¸ªè¯­è¨€ç‰ˆæœ¬çš„å®ç°ã€‚è§<a href="https://en.wikipedia.org/wiki/Thread-local_storage#Java">Thread-local storage</a></p>

<h2>Javaå®ç°ï¼šThreadLocal</h2>

<p>JDK 1.2çš„ç‰ˆæœ¬ä¸­å°±æä¾›java.lang.ThreadLocalï¼ŒThreadLocalä¸ºè§£å†³å¤šçº¿ç¨‹ç¨‹åºçš„å¹¶å‘é—®é¢˜æä¾›äº†ä¸€ç§æ–°çš„æ€è·¯ã€‚ä½¿ç”¨è¿™ä¸ªå·¥å…·ç±»å¯ä»¥å¾ˆç®€æ´åœ°ç¼–å†™å‡ºä¼˜ç¾çš„å¤šçº¿ç¨‹ç¨‹åºï¼ŒThreadLocalå¹¶ä¸æ˜¯ä¸€ä¸ªThreadï¼Œè€Œæ˜¯Threadçš„å±€éƒ¨å˜é‡ã€‚</p>

<p><code>java.lang.ThreadLocal&lt;GeneratorSession&gt;</code></p>

<h3>æºä»£ç  (åªæ˜¾ç¤ºsetå’Œgetæ–¹æ³•)</h3>

<pre><code> public void set(T value) {  
    Thread t = Thread.currentThread();  
    ThreadLocalMap map = getMap(t);  
    if (map != null)  
        map.set(this, value);  
    else  
        createMap(t, value);  
}  
public T get() {  
    Thread t = Thread.currentThread();  
    ThreadLocalMap map = getMap(t);  
    if (map != null)  
        return (T)map.get(this);  

    // Maps are constructed lazily.  if the map for this thread  
    // doesn't exist, create it, with this ThreadLocal and its  
    // initial value as its only entry.  
    T value = initialValue();  
    createMap(t, value);  
    return value;  
}  
</code></pre>

<h3>åº”ç”¨</h3>

<h4>hibernateä¸­çš„ä¸€ä¸ªå…¸å‹åº”ç”¨</h4>

<pre><code>private static final ThreadLocal threadSession = new ThreadLocal();
public static Session getSession() throws InfrastructureException {
    Session s = (Session) threadSession.get();
    try {
        if (s == null) {
            s = getSessionFactory().openSession();
            threadSession.set(s);
        }
    } catch (HibernateException ex) {
        throw new InfrastructureException(ex);
    }
    return s;
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°åœ¨getSession()æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹ä¸­æœ‰æ²¡æœ‰æ”¾è¿›å»sessionï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œé‚£ä¹ˆé€šè¿‡sessionFactory().openSession()æ¥åˆ›å»ºä¸€ä¸ªsessionï¼Œå†å°†session setåˆ°çº¿ç¨‹ä¸­ï¼Œå®é™…æ˜¯æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMapè¿™ä¸ªmapä¸­ï¼Œè¿™æ—¶ï¼Œå¯¹äºè¿™ä¸ªsessionçš„å”¯ä¸€å¼•ç”¨å°±æ˜¯å½“å‰çº¿ç¨‹ä¸­çš„é‚£ä¸ªThreadLocalMapï¼ˆä¸‹é¢ä¼šè®²åˆ°ï¼‰ï¼Œè€ŒthreadSessionä½œä¸ºè¿™ä¸ªå€¼çš„keyï¼Œè¦å–å¾—è¿™ä¸ªsessionå¯ä»¥é€šè¿‡threadSession.get()æ¥å¾—åˆ°ï¼Œé‡Œé¢æ‰§è¡Œçš„æ“ä½œå®é™…æ˜¯å…ˆå–å¾—å½“å‰çº¿ç¨‹ä¸­çš„ThreadLocalMapï¼Œç„¶åå°†threadSessionä½œä¸ºkeyå°†å¯¹åº”çš„å€¼å–å‡ºã€‚è¿™ä¸ªsessionç›¸å½“äºçº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼Œè€Œä¸æ˜¯publicçš„ã€‚
æ˜¾ç„¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸­æ˜¯å–ä¸åˆ°è¿™ä¸ªsessionçš„ï¼Œä»–ä»¬ä¹Ÿåªèƒ½å–åˆ°è‡ªå·±çš„ThreadLocalMapä¸­çš„ä¸œè¥¿ã€‚è¦æ˜¯sessionæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«ä½¿ç”¨çš„ï¼Œé‚£è¿˜ä¸ä¹±å¥—äº†ã€‚
è¯•æƒ³å¦‚æœä¸ç”¨ThreadLocalæ€ä¹ˆæ¥å®ç°å‘¢ï¼Ÿå¯èƒ½å°±è¦åœ¨actionä¸­åˆ›å»ºsessionï¼Œç„¶åæŠŠsessionä¸€ä¸ªä¸ªä¼ åˆ°serviceå’Œdaoä¸­ï¼Œè¿™å¯å¤Ÿéº»çƒ¦çš„ã€‚æˆ–è€…å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªé™æ€çš„mapï¼Œå°†å½“å‰threadä½œä¸ºkeyï¼Œåˆ›å»ºçš„sessionä½œä¸ºå€¼ï¼Œputåˆ°mapä¸­ï¼Œåº”è¯¥ä¹Ÿè¡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸€èˆ¬äººçš„æƒ³æ³•ï¼Œä½†äº‹å®ä¸Šï¼ŒThreadLocalçš„å®ç°åˆšå¥½ç›¸åï¼Œå®ƒæ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªmapï¼Œè€Œå°†ThreadLocalå®ä¾‹ä½œä¸ºkeyï¼Œè¿™æ ·æ¯ä¸ªmapä¸­çš„é¡¹æ•°å¾ˆå°‘ï¼Œè€Œä¸”å½“çº¿ç¨‹é”€æ¯æ—¶ç›¸åº”çš„ä¸œè¥¿ä¹Ÿä¸€èµ·é”€æ¯äº†ï¼Œä¸çŸ¥é“é™¤äº†è¿™äº›è¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„å¥½å¤„ã€‚</p>

<p>æ­¤æ®µæ–‡å­—æ¥è‡ªï¼š<a href="http://www.iteye.com/topic/103804">http://www.iteye.com/topic/103804</a></p>

<h4>å®é™…é¡¹ç›®çš„ä¸€ä¸ªç”¨å¤„</h4>

<p>éœ€è¦å¯¹æ¯ä¸ªè¯·æ±‚çº¿ç¨‹åˆ†é…ä¸€ä¸ªGeneratorSessionï¼Œä¸”è¦æ±‚GeneratorSessionèƒ½æ”¯æŒé«˜å¹¶å‘ã€‚ä½¿ç”¨åˆ°äº†ThreadLocalã€‚</p>

<pre><code>public class GeneratorSessionFactoryImpl implements GeneratorSessionFactory {

private ThreadLocal&lt;GeneratorSession&gt; generatorSessions = new ThreadLocal&lt;GeneratorSession&gt;();

private Settings settings;

public GeneratorSessionFactoryImpl(Settings settings) {
    this.settings = settings;
}

/**
 * çº¿ç¨‹å®‰å…¨åˆ›å»ºGeneratorSession
 * 
 * @see com.trs.dev4.jdk16.cms.GeneratorSessionFactory#getCurrentSession()
 * @since yangyu @ Apr 11, 2013
 */
public GeneratorSession getCurrentSession() {

    GeneratorSession generatorSession = generatorSessions.get();
    if (generatorSession == null) {
        generatorSession = new GeneratorSessionImpl(settings);
        generatorSessions.set(generatorSession);
    }
    return generatorSession;
}

public Settings getSettings() {
    return settings;
}

}
</code></pre>

<h2>Objective-Cå®ç°</h2>

<p>åœ¨Cocoaä¸­ï¼Œæ¯ä¸ªNSThreadå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„dictionaryã€‚</p>

<pre><code>NSMutableDictionary *dict = [[NSThread currentThread] threadDictionary];
dict[@"A key"] = @"Some data";
</code></pre>

<p>å‚è€ƒæ–‡ç« ï¼š<br/>
<a href="https://en.wikipedia.org/wiki/Thread-local_storage#C.2B.2B">https://en.wikipedia.org/wiki/Thread-local_storage#C.2B.2B</a><br/>
<a href="http://www.iteye.com/topic/103804">http://www.iteye.com/topic/103804</a></p>
</div>


<div class="meta">
	<div class="date">




Jun 3rd, 2014</div>
	<div class="tags">

</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    æ˜“è£ä¹‰

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>